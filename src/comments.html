<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="theme-color" content="#ffffff">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Commenta dashboard</title>

    <style>
      th {
        text-align: left;
      }

      .comment-item {
        padding: 10px 0 30px 0;
        border-bottom: 2px inset gray;
      }
    </style>

  </head>

  <body>

    <h1>Comments</h1>
    <div id="results"></div>

    <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-database.js"></script>
    <script src="static/comments.js"></script>

    <script>

      // var tableResults = document.querySelector('#results tbody');
      var resultsPlaceholder = document.querySelector('#results');

      function snapshotToArray(snapshot) {
        var returnArr = [];
        snapshot.forEach(function (childSnapshot) {
          var arrItem = childSnapshot.val();
          arrItem.key = childSnapshot.key;
          returnArr.push(arrItem);
        });

        var comments = [];
        returnArr.forEach(function (item) {
          var keys = Object.keys(item);
          for (var key of keys) {
            let group = item.key;
            if (key !== 'key') {
              for (var itemKey of Object.keys(item[key])) {
                item[key][itemKey].slug = key;
                item[key][itemKey].group = group;
                item[key][itemKey].itemKey = itemKey
                comments.push(item[key][itemKey]);
              }
            }
          }
        });

        return comments;
      };

      var path = window.location.hostname.replace('.', '-') + '/comments';
      var ref = firebase.database().ref(path);
      ref.on("value", function (snap) {
        resultsPlaceholder.innerHTML = '';
        var comments = snapshotToArray(snap);
        comments.forEach(function (item) {
          var commentContent = document.createElement('div');

          commentContent.classList.add('comment-item');
          commentContent.innerHTML = `
            <p><b>${item.name} (${item.published})</b><br>
               <i>${item.group}/${item.slug}</i></p>
            <p>${item.comment}</p>
          `;

          var buttonDelete = document.createElement('button');
          buttonDelete.innerText = 'Delete comment';
          buttonDelete.dataset.id = `${window.location.hostname.replace('.', '-')}/comments/${item.group}/${item.slug}/${item.itemKey}`;
          buttonDelete.addEventListener('click', function (evt) {
            if (confirm('Are you sure you want to delete this comment?')) {
              firebase.database().ref(evt.target.dataset.id).remove();
            }
          });

          commentContent.appendChild(buttonDelete);
          resultsPlaceholder.appendChild(commentContent);
        });
      }, function (errorObject) {
        console.log(`The read failed: ${errorObject.code}`);
      });

    </script>

  </body>

</html>
